# Deploying Supabase to Coolify

## Problem
Coolify is auto-detecting this repository as a Deno application, but this is a Supabase monorepo that should be deployed using **Docker Compose**.

## Solution: Configure Coolify to Use Docker Compose

### Step 1: Create Docker Compose Resource in Coolify

1. In Coolify dashboard, go to your project
2. Click **"Add Resource"** â†’ **"Docker Compose"** (NOT "Application")
3. Configure the following:

### Step 2: Build Configuration

- **Build Context**: `/docker` 
  - This tells Coolify to use the `docker/` directory as the build context
- **Docker Compose File**: `docker-compose.yml`
- **Docker Compose File Location**: Should point to `docker/docker-compose.yml`

### Step 3: Environment Variables

Add all environment variables from `docker/.env.example` in Coolify's environment variables section. Key variables:

```
POSTGRES_PASSWORD=<your-secure-password>
JWT_SECRET=<your-jwt-secret>
ANON_KEY=<your-anon-key>
SERVICE_ROLE_KEY=<your-service-role-key>
DASHBOARD_USERNAME=admin
DASHBOARD_PASSWORD=<your-dashboard-password>
SECRET_KEY_BASE=<your-secret-key-base>
VAULT_ENC_KEY=<your-vault-key>
PG_META_CRYPTO_KEY=<your-pg-meta-key>
LOGFLARE_PUBLIC_ACCESS_TOKEN=<your-logflare-public>
LOGFLARE_PRIVATE_ACCESS_TOKEN=<your-logflare-private>
POOLER_TENANT_ID=<your-tenant-id>
```

**Important**: Use the production-ready passwords generated by `docker/update-env-production.ps1`

### Step 4: Ports Configuration

In Coolify, expose these ports:
- **8000** - API Gateway (Kong)
- **54323** - Studio Dashboard
- **9000** - Inbucket (Email Testing)
- **54322** - Database (optional, for direct access)

### Step 5: Volumes

Coolify will automatically handle volumes. The important ones are:
- `./volumes/db/data` - Database persistence
- `./volumes/storage` - File storage

## Alternative: If Coolify Still Detects as Deno

If Coolify still tries to build as Deno:

1. **Check `.nixpacksignore`** - This file should prevent auto-detection
2. **Manually select Docker Compose** - Don't let Coolify auto-detect
3. **Set Build Pack to "None"** - Force Docker Compose mode

## Troubleshooting

### Error: "Found application type: deno"
- Solution: Make sure you selected "Docker Compose" resource type, not "Application"
- Check that `.nixpacksignore` exists in the root directory

### Error: "Relative import path not prefixed"
- This happens when Coolify tries to build as Deno
- Solution: Use Docker Compose deployment instead

### Services not starting
- Check all environment variables are set in Coolify
- Verify Docker Compose file path is correct
- Check Coolify logs for specific errors

## Quick Setup Checklist

- [ ] Created Docker Compose resource (not Application)
- [ ] Set build context to `/docker`
- [ ] Set Docker Compose file to `docker-compose.yml`
- [ ] Added all environment variables from `.env.example`
- [ ] Exposed ports: 8000, 54323, 9000
- [ ] Verified `.nixpacksignore` exists in root

## After Deployment

Once deployed, access:
- **Studio**: `https://your-coolify-domain:54323`
- **API**: `https://your-coolify-domain:8000`
- **Email Testing**: `https://your-coolify-domain:9000`

